name: Deploy LeetCode Note to Cloud Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å¢åŠ æ•´ä½“è¶…æ—¶æ—¶é—´
    
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        timeout-minutes: 3

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
        timeout-minutes: 5

      - name: ğŸ“¥ Install Dependencies
        run: |
          echo "å¼€å§‹å®‰è£…ä¾èµ–..."
          npm ci --silent
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        timeout-minutes: 8

      - name: ğŸ”¨ Build Project
        run: |
          echo "å¼€å§‹æ„å»ºé¡¹ç›®..."
          npm run build
          echo "âœ… æ„å»ºå®Œæˆï¼ŒéªŒè¯æ–‡ä»¶..."
          ls -la build/
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find build -type f | wc -l)"
          echo "ğŸ“¦ æ„å»ºå¤§å°: $(du -sh build | cut -f1)"
        timeout-minutes: 5

      - name: ğŸ§ª Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30s
          command_timeout: 2m
          script: |
            echo "ğŸ§ª æµ‹è¯•SSHè¿æ¥..."
            echo "âœ… SSHè¿æ¥æˆåŠŸ"
            echo "ğŸ“ æœåŠ¡å™¨: $(hostname)"
            echo "ğŸ‘¤ ç”¨æˆ·: $(whoami)"
            echo "ğŸ• æ—¶é—´: $(date)"

      - name: ğŸ“¤ Upload Build Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 5m
          source: "build/*"
          target: "/home/${{ secrets.USERNAME }}/leetcode-note-build-${{ github.run_number }}"
          strip_components: 1

      - name: ğŸ” Verify Upload
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 1m
          command_timeout: 2m
          script: |
            BUILD_DIR="/home/${{ secrets.USERNAME }}/leetcode-note-build-${{ github.run_number }}"
            echo "ğŸ” éªŒè¯æ–‡ä»¶ä¸Šä¼ ..."
            if [ -d "$BUILD_DIR" ]; then
              echo "âœ… æ„å»ºç›®å½•å­˜åœ¨: $BUILD_DIR"
              echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find $BUILD_DIR -type f | wc -l)"
              echo "ğŸ“¦ ç›®å½•å¤§å°: $(du -sh $BUILD_DIR | cut -f1)"
              if [ -f "$BUILD_DIR/index.html" ]; then
                echo "âœ… ä¸»é¡µæ–‡ä»¶å­˜åœ¨"
              else
                echo "âŒ ä¸»é¡µæ–‡ä»¶ç¼ºå¤±"
                exit 1
              fi
            else
              echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

      - name: ğŸ› ï¸ Prepare Deployment Environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 2m
          command_timeout: 3m
          script: |
            echo "ğŸ› ï¸ å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ..."
            
            # åˆ›å»ºå¿…è¦ç›®å½•
            mkdir -p /home/${{ secrets.USERNAME }}/logs
            mkdir -p /home/${{ secrets.USERNAME }}/backups
            
            # æ£€æŸ¥Webç›®å½•æƒé™
            WEB_DIR="/var/www/leetcode-note"
            if [ ! -d "$WEB_DIR" ]; then
              echo "âš ï¸ Webç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
              echo "è¯·åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ: sudo mkdir -p $WEB_DIR && sudo chown ${{ secrets.USERNAME }}:www-data $WEB_DIR"
              exit 1
            fi
            
            if [ ! -w "$WEB_DIR" ]; then
              echo "âš ï¸ æ²¡æœ‰Webç›®å½•å†™æƒé™"
              echo "è¯·åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ: sudo chown ${{ secrets.USERNAME }}:www-data $WEB_DIR"
              exit 1
            fi
            
            echo "âœ… éƒ¨ç½²ç¯å¢ƒæ£€æŸ¥é€šè¿‡"

      - name: ğŸš€ Execute Deployment Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 5m          # SSHè¿æ¥è¶…æ—¶
          command_timeout: 15m  # å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œç»™éƒ¨ç½²è„šæœ¬å……è¶³æ—¶é—´
          script: |
            # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›éƒ¨ç½²è„šæœ¬ä½¿ç”¨
            export BUILD_SOURCE="/home/${{ secrets.USERNAME }}/leetcode-note-build-${{ github.run_number }}"
            export DEPLOY_TIMESTAMP="$(date '+%Y%m%d_%H%M%S')"
            export DEPLOY_RUN_NUMBER="${{ github.run_number }}"
            export DEPLOY_COMMIT="${{ github.sha }}"
            export DEPLOY_ACTOR="${{ github.actor }}"
            export DEPLOY_BRANCH="${{ github.ref_name }}"
            
            echo "ğŸš€ å¼€å§‹æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            echo "================================================"
            echo "ğŸ“‚ æ„å»ºæº: $BUILD_SOURCE"
            echo "ğŸ• éƒ¨ç½²æ—¶é—´: $DEPLOY_TIMESTAMP"
            echo "ğŸ”¢ æ„å»ºå·: $DEPLOY_RUN_NUMBER"
            echo "ğŸ”— æäº¤: $DEPLOY_COMMIT"
            echo "ğŸ‘¤ è§¦å‘è€…: $DEPLOY_ACTOR"
            echo "ğŸŒ¿ åˆ†æ”¯: $DEPLOY_BRANCH"
            echo "================================================"
            
            # æ£€æŸ¥éƒ¨ç½²è„šæœ¬æ˜¯å¦å­˜åœ¨
            DEPLOY_SCRIPT="/opt/scripts/leetcode-note_deploy.sh"
            if [ ! -f "$DEPLOY_SCRIPT" ]; then
              echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: $DEPLOY_SCRIPT"
              echo "è¯·ç¡®ä¿åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºäº†è¯¥è„šæœ¬"
              exit 1
            fi
            
            # æ£€æŸ¥è„šæœ¬æƒé™
            if [ ! -x "$DEPLOY_SCRIPT" ]; then
              echo "âš ï¸ éƒ¨ç½²è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œå°è¯•ä¿®å¤..."
              chmod +x "$DEPLOY_SCRIPT" || {
                echo "âŒ æ— æ³•ä¿®æ”¹è„šæœ¬æƒé™ï¼Œå°è¯•ä½¿ç”¨sudo..."
                sudo chmod +x "$DEPLOY_SCRIPT" || {
                  echo "âŒ æ— æ³•ä¿®æ”¹è„šæœ¬æƒé™"
                  exit 1
                }
              }
              echo "âœ… è„šæœ¬æƒé™ä¿®å¤å®Œæˆ"
            fi
            
            echo "âœ… éƒ¨ç½²è„šæœ¬æ£€æŸ¥é€šè¿‡"
            echo "ğŸ”§ å¼€å§‹æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            echo "================================================"
            
            # æ ¹æ®è„šæœ¬éœ€è¦çš„æƒé™ï¼Œå°è¯•ä¸åŒçš„æ‰§è¡Œæ–¹å¼
            if [ -w "/var/www/leetcode-note" ] 2>/dev/null; then
              # å¦‚æœæœ‰Webç›®å½•å†™æƒé™ï¼Œç›´æ¥æ‰§è¡Œ
              echo "â„¹ï¸ ä½¿ç”¨å½“å‰ç”¨æˆ·æƒé™æ‰§è¡Œè„šæœ¬..."
              "$DEPLOY_SCRIPT"
            else
              # å¦‚æœæ²¡æœ‰å†™æƒé™ï¼Œå°è¯•ä½¿ç”¨sudo
              echo "â„¹ï¸ ä½¿ç”¨sudoæƒé™æ‰§è¡Œè„šæœ¬..."
              sudo "$DEPLOY_SCRIPT"
            fi
            
            SCRIPT_EXIT_CODE=$?
            echo "================================================"
            
            if [ $SCRIPT_EXIT_CODE -eq 0 ]; then
              echo "âœ… éƒ¨ç½²è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            else
              echo "âŒ éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $SCRIPT_EXIT_CODE"
              exit $SCRIPT_EXIT_CODE
            fi

      - name: ğŸ”„ Restart Web Service (Optional)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 1m
          command_timeout: 2m
          script: |
            echo "ğŸ”„ é‡å¯WebæœåŠ¡..."
            
            # å°è¯•é‡è½½nginxï¼ˆéœ€è¦sudoæƒé™ï¼‰
            if sudo -n nginx -t >/dev/null 2>&1; then
              sudo -n systemctl reload nginx && echo "âœ… Nginxé‡è½½æˆåŠŸ" || echo "âš ï¸ Nginxé‡è½½å¤±è´¥"
            else
              echo "â„¹ï¸ è·³è¿‡Nginxé‡è½½ï¼ˆéœ€è¦sudoæƒé™ï¼‰"
            fi
        continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­

      - name: ğŸ” Post-Deployment Verification
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 2m
          command_timeout: 5m
          script: |
            echo "ğŸ” æ‰§è¡Œéƒ¨ç½²åéªŒè¯..."
            
            # æ£€æŸ¥Webç›®å½•
            WEB_DIR="/var/www/leetcode-note"
            echo "ğŸ“ æ£€æŸ¥Webç›®å½•: $WEB_DIR"
            
            if [ -d "$WEB_DIR" ]; then
              FILE_COUNT=$(find "$WEB_DIR" -type f 2>/dev/null | wc -l)
              if [ "$FILE_COUNT" -gt 0 ]; then
                DIR_SIZE=$(du -sh "$WEB_DIR" 2>/dev/null | cut -f1)
                echo "âœ… Webç›®å½•åŒ…å« $FILE_COUNT ä¸ªæ–‡ä»¶ï¼Œå¤§å°: $DIR_SIZE"
                
                # æ£€æŸ¥å…³é”®æ–‡ä»¶
                if [ -f "$WEB_DIR/index.html" ]; then
                  echo "âœ… ä¸»é¡µæ–‡ä»¶å­˜åœ¨"
                else
                  echo "âš ï¸ ä¸»é¡µæ–‡ä»¶ä¸å­˜åœ¨"
                fi
                
                # æ˜¾ç¤ºéƒ¨åˆ†æ–‡ä»¶åˆ—è¡¨
                echo "ğŸ“„ ä¸»è¦æ–‡ä»¶åˆ—è¡¨ï¼š"
                ls -la "$WEB_DIR/" | head -10
              else
                echo "âŒ Webç›®å½•ä¸ºç©º"
                echo "ğŸ” æ£€æŸ¥éƒ¨ç½²è„šæœ¬æ—¥å¿—..."
                if [ -f "/opt/logs/leetcode-note-deploy.log" ]; then
                  echo "ğŸ“‹ æœ€è¿‘çš„éƒ¨ç½²æ—¥å¿—ï¼š"
                  tail -20 /opt/logs/leetcode-note-deploy.log
                fi
                exit 1
              fi
            else
              echo "âŒ Webç›®å½•ä¸å­˜åœ¨: $WEB_DIR"
              exit 1
            fi
            
            echo ""
            echo "ğŸŒ æ‰§è¡Œç½‘ç«™å¥åº·æ£€æŸ¥..."
            sleep 3  # ç­‰å¾…æœåŠ¡ç¨³å®š
            
            # æ£€æŸ¥å¤šä¸ªç«¯ç‚¹
            ENDPOINTS=("http://localhost" "http://127.0.0.1" "http://localhost:80")
            SUCCESS=false
            
            for endpoint in "${ENDPOINTS[@]}"; do
              echo "ğŸ”— æµ‹è¯•: $endpoint"
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$endpoint" 2>/dev/null || echo "000")
              
              case "$RESPONSE" in
                "200")
                  echo "âœ… $endpoint å“åº”æ­£å¸¸ (HTTP $RESPONSE)"
                  SUCCESS=true
                  break
                  ;;
                "000")
                  echo "âš ï¸ $endpoint è¿æ¥å¤±è´¥"
                  ;;
                *)
                  echo "âš ï¸ $endpoint å“åº”å¼‚å¸¸ (HTTP $RESPONSE)"
                  ;;
              esac
            done
            
            if [ "$SUCCESS" = "true" ]; then
              echo ""
              echo "ğŸ‰ éƒ¨ç½²éªŒè¯æˆåŠŸï¼"
              echo "âœ… æ–‡ä»¶éƒ¨ç½²å®Œæˆ"
              echo "âœ… ç½‘ç«™å“åº”æ­£å¸¸"
            else
              echo ""
              echo "âš ï¸ ç½‘ç«™å“åº”å¼‚å¸¸ï¼Œä½†æ–‡ä»¶éƒ¨ç½²å¯èƒ½ä»ç„¶æˆåŠŸ"
              echo "ğŸ” å¯èƒ½çš„åŸå› ï¼š"
              echo "  - Nginxé…ç½®é—®é¢˜"
              echo "  - æœåŠ¡æœªå¯åŠ¨"
              echo "  - é˜²ç«å¢™è®¾ç½®"
              echo ""
              echo "ğŸ”§ è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š"
              echo "  - sudo systemctl status nginx"
              echo "  - sudo nginx -t"
              echo "  - sudo systemctl reload nginx"
              
              # ä¸å› ä¸ºå¥åº·æ£€æŸ¥å¤±è´¥è€Œæ•´ä½“å¤±è´¥ï¼Œå› ä¸ºæ–‡ä»¶å¯èƒ½å·²ç»éƒ¨ç½²æˆåŠŸ
              echo ""
              echo "â„¹ï¸ æ–‡ä»¶éƒ¨ç½²å·²å®Œæˆï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ç½‘ç«™çŠ¶æ€"
            fi

      - name: ğŸ§¹ Cleanup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 1m
          command_timeout: 2m
          script: |
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            
            # æ¸…ç†æ„å»ºæ–‡ä»¶
            BUILD_DIR="/home/${{ secrets.USERNAME }}/leetcode-note-build-${{ github.run_number }}"
            if [ -d "$BUILD_DIR" ]; then
              rm -rf "$BUILD_DIR"
              echo "âœ… æ¸…ç†æ„å»ºæ–‡ä»¶: $BUILD_DIR"
            fi
            
            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
            BACKUP_DIR="/home/${{ secrets.USERNAME }}/backups"
            if [ -d "$BACKUP_DIR" ]; then
              find "$BACKUP_DIR" -name "backup_*" -type d -mtime +5 -exec rm -rf {} \; 2>/dev/null || true
              echo "âœ… æ¸…ç†æ—§å¤‡ä»½å®Œæˆ"
            fi
            
            echo "ğŸ‰ éƒ¨ç½²æµç¨‹å…¨éƒ¨å®Œæˆï¼"
        if: always()  # æ€»æ˜¯æ‰§è¡Œæ¸…ç†

      - name: ğŸ“Š Deployment Summary
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30s
          command_timeout: 1m
          script: |
            echo "ğŸ“Š éƒ¨ç½²æ‘˜è¦"
            echo "=================="
            echo "ğŸ• å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "ğŸ”— æäº¤: ${{ github.sha }}"
            echo "ğŸ‘¤ è§¦å‘è€…: ${{ github.actor }}"
            echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
            echo "ğŸ—ï¸ æ„å»ºå·: ${{ github.run_number }}"
            
            WEB_DIR="/var/www/leetcode-note"
            if [ -d "$WEB_DIR" ]; then
              echo "ğŸ“ Webç›®å½•: âœ…"
              echo "ğŸ“„ æ–‡ä»¶æ•°: $(find "$WEB_DIR" -type f | wc -l)"
              echo "ğŸ’¾ å¤§å°: $(du -sh "$WEB_DIR" | cut -f1)"
            else
              echo "ğŸ“ Webç›®å½•: âŒ"
            fi
        if: always()